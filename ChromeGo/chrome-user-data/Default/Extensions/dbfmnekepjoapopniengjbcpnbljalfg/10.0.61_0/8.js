(window.webpackJsonp=window.webpackJsonp||[]).push([[8],{346:function(t,e,i){"use strict";i.d(e,"b",(function(){return n})),i.d(e,"f",(function(){return l})),i.d(e,"a",(function(){return c})),i.d(e,"c",(function(){return d})),i.d(e,"e",(function(){return p})),i.d(e,"d",(function(){return u}));var s=i(7),o=i.n(s),r=(i(10),i(13),i(17),i(0)),a=i(190);function n(t){let e=0;switch(t){case"per-hour":e=r.q?36e5:2e4;break;case"twelve-hour":e=432e5;break;case"one-day":e=864e5}return e}async function l(t){let e;var i;return e="string"==typeof t?await(i=t,fetch(i).then(t=>t.blob())):t,await new o.a((t,i)=>{const s=new FileReader;s.readAsDataURL(e),s.onload=()=>{t(s.result)},s.onerror=i})}function c(t,e="cloud"){return t.map(t=>({type:e,id:t._id,url:t.url,content:t.thumbnail,like:t.like,source:t.source,rawUrl:t.rawUrl}))}async function d(){const t=await Object(a.getBingWallpaper)();if(t.error)throw t.error;const[e]=c([t.data]);return e}function p(t){return!["image/gif"].includes(t.type)&&t.size>window.__INFINITY__.maxLocalFileSize}async function u(){const t=await Object(a.getCustomColor)();if(!t.error)return t.data.map(t=>(t.type="color",t));console.warn(t.error)}},574:function(t,e,i){"use strict";i.r(e),i.d(e,"syncStore",(function(){return E}));var s=i(7),o=i.n(s),r=i(105),a=i.n(r),n=(i(13),i(17),i(10),i(52),i(18),i(3)),l=i(81),c=i(246),d=i(585),p=i(391),u=i(586),h=i(583),y=i(345),g=i(587),m=i(390),b=i(584),f=i(1),w=i(245),v=f.b`.container {
  width: 410px;
  box-sizing: border-box;
  padding: 40px 40px 34px 40px;
  background: #ffffff;
  border-radius: 6px;
}
.header {
  text-align: center;
  line-height: 30px;
  height: 28px;
  font-size: 20px;
  font-weight: 500;
  color: #333333;
  line-height: 28px;
}
.main {
  margin: 24px auto 40px;
}
.tips {
  margin-bottom: 30px;
  font-size: 14px;
  font-weight: 400;
  color: #656565;
  line-height: 20px;
}
.checkbox {
  display: flex;
  align-items: center;
  position: relative;
  margin-bottom: 20px;
  font-size: 14px;
  font-weight: 400;
  color: #333333;
  cursor: pointer;
}
.checkbox .input-box {
  display: flex;
  align-items: center;
  position: relative;
}
.checkbox label {
  box-sizing: border-box;
  position: absolute;
  top: 0;
  left: 0;
  width: 16px;
  height: 16px;
  border: 2px solid #333;
  border-radius: 8px;
  cursor: pointer;
}
.checkbox label::after {
  content: '';
  width: 9px;
  height: 5px;
  position: absolute;
  top: 1px;
  left: 1px;
  border: 2px solid #333;
  border-top: none;
  border-right: none;
  background: transparent;
  opacity: 0;
  transform: rotate(-45deg);
}
.checkbox input {
  visibility: hidden;
}
.checkbox input:checked + label::after {
  opacity: 1;
}
.checkbox:last-of-type {
  margin-bottom: 0;
}
.btn {
  width: 330px;
  height: 52px;
}
`,I=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a};let _=class extends w.a{constructor(){super(...arguments),this.onChecked=t=>{},this.show=!1,this.checked=0,this.handleCheck=t=>{this.show=!1,"function"==typeof this.onChecked&&this.onChecked(t),this.checked=0,this.onChecked=()=>{}}}static create(t){const e=document.body.querySelector("#modal-first-sync");if(e){if(!this.instance){const t=document.createElement("modal-first-sync");e.appendChild(t),this.instance=t}return this.instance.show=!0,this.instance.onChecked=t,this.instance}}static hide(){this.instance&&this.instance.show&&this.instance.handleCheck(null)}firstUpdated(){}checkOne(t){this.checked=t}updated(){this.radios[this.checked].checked=!0}render(){return f.e`<infinito-modal style="--modal-padding:0;" .closeable="${!1}" .open=${this.show}>
      <div slot="body">
        <div class="container">
          <div class="header">${i18n("choose_sync_type")}</div>
          <div class="main">
            <div class="tips">${i18n("sync_type_tips")}</div>
            <div class="checkbox-box">
              <div class="checkbox" @click="${()=>this.checkOne(0)}">
                <div class="input-box">
                  <input name="first_sync" type="radio" value="0" id="first_sync_0" />
                  <label for="first_sync_0"></label>
                </div>
                <span>${i18n("merge_cloud_local")}</span>
              </div>
              <div class="checkbox" @click="${()=>this.checkOne(1)}">
                <div class="input-box">
                  <input name="first_sync" type="radio" value="1" id="first_sync_1" />
                  <label for="first_sync_1"></label>
                </div>
                <span>${i18n("use_local")}</span>
              </div>
              <div class="checkbox" @click="${()=>this.checkOne(2)}">
                <div class="input-box">
                  <input name="first_sync" type="radio" value="2" id="first_sync_2" />
                  <label for="first_sync_2"></label>
                </div>
                <span>${i18n("use_cloud")}</span>
              </div>
            </div>
          </div>
          <div class="footer">
            <infinito-button
              primary
              class="btn"
              @click="${()=>{this.handleCheck(this.checked)}}"
              >${i18n("confirm")}</infinito-button
            >
          </div>
        </div>
      </div>
    </infinito-modal> `}};_.styles=v,_.instance=null,I([Object(f.g)()],_.prototype,"onChecked",void 0),I([Object(f.g)({type:Boolean})],_.prototype,"show",void 0),I([Object(f.g)({type:Number})],_.prototype,"checked",void 0),I([Object(f.i)('[name="first_sync"]')],_.prototype,"radios",void 0),_=I([Object(f.c)("modal-first-sync")],_);var C=i(178),O=i(0),S=i(346),j=i(247),k=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a};const L=[p.b,d.a,h.a,u.a,y.a,g.a,b.weatherStore];class R extends c.a{constructor(){super(...arguments),this.timmer=null,this.downloading=!1,this.backuping=!1,this.isBackup=!1,this.isOpenSync=!0,this.syncId="",this.lastSyncTime=0,this.syncSucsess=!1,this.syncFail=!1,this.syncFailMsg="",this.autosSyncList=[],this.waitMergeData=null,this.waitMergeId=null,this.manualSyncList={},this.isRecovered=!1,this.recoverErrorTimes=0,this.master=!1,this.prerender=[],this.autoBackupPipe={data:{},websocketKeys:[],timestamp:0},this.getAllBackupData=async()=>{const t={};return await o.a.all(L.map(async e=>{const i=await e.getBackupData();t[e.backupFileKey]=i})),t},this.getAutoLatest=async(t="all")=>{const e=localStorage.getItem("lock-auto-recover");if(e&&Date.now()-Number(e)<50)return;if(localStorage.setItem("lock-auto-recover",""+Date.now()),await this.getSyncList(),0===this.autosSyncList.length){const t=m.userStore.userInfo["backup-version-v2"];if(m.userStore.userInfo["auto-backup"]&&!t){const t=m.userStore.userInfo.email?"basic":"pro";await this.getV1RemoteData(t)}else this.tiggerBackup();return}const i=this.autosSyncList[0];if((null==i?void 0:i.id)===this.syncId||this.waitMergeId===(null==i?void 0:i.id))return;const s=localStorage.getItem("pre-sync-id");s&&(null==i?void 0:i.id)===s||(await this.getDetail(i.id,"auto",t,!1,!0),localStorage.removeItem("lock-auto-recover"))},this.changeSyncStatus=t=>{this.master=!1,this.downloading=t.downloading,this.backuping=t.backuping,this.isBackup=t.isBackup,this.syncFail=t.syncFail,this.syncFailMsg=t.syncFailMsg,this.syncSucsess=t.syncSucsess,(this.syncSucsess||this.syncFail)&&this.syncEnd()}}get autoSyncing(){return this.downloading||this.backuping}async changeSyncSwitch(t){this.isOpenSync=t}async autoBackup(t,e=""){const i=await this.toSync(!0,t,e);return i.error||Object(n.i)(()=>{this.autosSyncList=i.data}),i}async manualBackup(){const{default:t}=await Promise.resolve().then(i.bind(null,358)),e=t.loading(i18n("backing_up")),{error:s,data:o}=await this.toSync();e(),s?t.error(i18n("backup_failed")):Object(n.i)(()=>{this.manualSyncList=o})}async toSync(t=!1,e={},i=""){var s,r;let a;if(this.master=!0,t)this.isBackup=!0,this.backuping=!0,a=await l.e.autoBackup(e,i);else{const t={};await o.a.all(L.map(async e=>{const i=await e.getBackupData();t[e.backupFileKey]=i})),a=await l.e.manualBackup(t)}const{error:n,data:c=[]}=a;return t&&(n||C.slave.postTask("slave:sync-to-server",i),n?this.backupEnd(n.message||"auto-backup error",null===(s=c[0])||void 0===s?void 0:s.id):this.backupEnd(null,null===(r=c[0])||void 0===r?void 0:r.id)),a}backupEnd(t,e=""){Object(n.i)(()=>{this.master=!0,this.backuping=!1,t?this.syncFail=!0:(this.syncSucsess=!0,e&&(this.syncId=e,this.lastSyncTime=Date.now()))}),this.syncEnd()}downloadEnd(t,e=""){Object(n.i)(()=>{this.master=!0,this.downloading=!1,this.backuping=!1,t?this.syncFail=!0:(this.syncSucsess=!0,e&&(this.syncId=e,this.lastSyncTime=Date.now()))}),this.syncEnd()}syncEnd(){clearTimeout(this.timmer),this.timmer=setTimeout(()=>{Object(n.i)(()=>{this.syncFail=!1,this.syncFailMsg="",this.syncSucsess=!1,this.isBackup=!1})},3e3)}async getSyncList(){const{data:t,error:e}=await l.e.getSyncList();if(e)throw e;Object(n.i)(()=>{this.autosSyncList=t.auto,this.manualSyncList=t.manual})}async getDetail(t,e,s="all",o=!1,r=!1){let a,n;if(this.master=!0,o){const{default:t}=await Promise.resolve().then(i.bind(null,358));a=t,n=a.loading(i18n("syncing"))}else this.downloading=!0,this.isBackup=!1;const{data:c,error:d}=await l.e.getSyncDetail(r?"latest":t,e,s);o&&(null==n||n()),d?o?null==a||a.error(i18n("sync_fail")):this.downloadEnd(d.message||"download error"):(await this.useRemote(c,o),this.downloadEnd(null,t),this.tiggerBackup())}tiggerBackup(){var t;this.changeRecoveredStatus(!0),(null===(t=this.autoBackupPipe.websocketKeys)||void 0===t?void 0:t.length)&&(this.autoBackupPipe.timestamp=Date.now())}async getV1RemoteData(t,e=!1){let s,o;if(this.master=!0,e){const{default:t}=await Promise.resolve().then(i.bind(null,358));s=t,o=s.loading(i18n("syncing"))}else this.downloading=!0,this.isBackup=!1;const{error:r,data:a}=await l.e.getV2DataFromV1(t);e&&(null==o||o()),r?(e?null==s||s.error(i18n("sync_fail")):this.downloadEnd(r.message||"download v1 error"),this.recoverErrorTimes+=1):(this.downloadEnd(null),await this.useRemote(a,e,!0),this.tiggerBackup())}changeRecoveredStatus(t){this.isRecovered=t}autoRunGetAutoLatest(){setTimeout(()=>{this.getAutoLatest()},0)}showModalAndCheckType(t=!1){return new o.a((e,i)=>{var s;if(t&&_.hide(),null===(s=_.instance)||void 0===s?void 0:s.show)return void e(null);const r=Object(n.j)(this.waitMergeData);_.create(async s=>{this.mergeType=s,this.diffColorItems();try{await o.a.all(L.map(async t=>{if(r&&r[t.backupFileKey])if(1===s)t.restartAutoBackupReaction(!0);else if(2===s)try{await t.mergeRemote(r[t.backupFileKey],!0),d.a.setRedirectVersion("")}catch(t){}else{if(0!==s)throw new Error("not check");try{await t.mergeRemote(r[t.backupFileKey],!1),d.a.setRedirectVersion("")}catch(t){}t.restartAutoBackupReaction(!0)}})),this.downloadEnd(null,this.waitMergeId),this.tiggerBackup(),Object(n.i)(()=>{this.waitMergeData=null,this.waitMergeId=null})}catch(e){t&&i(e)}e(null)})})}useLocalData(t){L.map(async e=>{if(null==t?void 0:t[e.backupFileKey])try{await e.mergeRemote(t[e.backupFileKey],!0)}catch(t){console.error("Store ~ syncStores.map ~ error",t)}})}useRemote(t,e,i=!1){return new o.a(async s=>{if(Object(n.i)(()=>{this.waitMergeData=null,this.waitMergeId=null}),e)await o.a.all(L.map(async e=>{if(null==t?void 0:t[e.backupFileKey])try{await e.mergeRemote(t[e.backupFileKey],!0),d.a.setRedirectVersion("")}catch(t){}})),this.mergeType=2,this.diffColorItems(),s(null);else if(this.isRecovered)await o.a.all(L.map(async e=>{if(null==t?void 0:t[e.backupFileKey])if(i)try{await e.mergeRemote(t[e.backupFileKey],!0)}catch(t){}else{e.stopAutoBackupReaction();try{await e.mergeRemote(t[e.backupFileKey],!0)}catch(t){}e.restartAutoBackupReaction()}})),s(null);else{L.some(e=>{if(t&&t[e.backupFileKey]){console.log("diffData ~ st.backupFileKey",e.backupFileKey);return e.diffRemote(t[e.backupFileKey])}return!1})?(Object(n.i)(()=>{var e;this.waitMergeData=t,this.waitMergeId=null===(e=this.autosSyncList[0])||void 0===e?void 0:e.id}),await this.showModalAndCheckType(!0),s(null)):(this.mergeType=2,this.diffColorItems(),await o.a.all(L.map(async e=>{if(null==t?void 0:t[e.backupFileKey])try{await e.mergeRemote(t[e.backupFileKey],!0)}catch(t){}})),s(null))}})}pushAutoBackupPipe(t){m.userStore.isLogin&&this.isOpenSync&&(Object.keys(t).forEach(e=>{this.autoBackupPipe.data[e]=t[e],this.autoBackupPipe.websocketKeys.includes(e)||this.autoBackupPipe.websocketKeys.push(e)}),this.autoBackupPipe.timestamp=Date.now())}cleanupPipe(t){t===this.autoBackupPipe.timestamp&&(this.autoBackupPipe={data:{},websocketKeys:[],timestamp:0})}async diffColorItems(){await m.userStore.userProfilePromise;const t=m.userStore.userInfo["wp-color-update"];if(t===m.userStore.wpColorUpdate)return;const{mergeType:e}=this,i=await Object(S.d)(),s=Object(n.j)(h.a.customColorItems);await h.a.mergeCustomColor(s,i,Number(e),!0),m.userStore.setWpColorUpdate(t)}}k([n.g],R.prototype,"downloading",void 0),k([n.g],R.prototype,"backuping",void 0),k([n.g],R.prototype,"isBackup",void 0),k([n.g],R.prototype,"isOpenSync",void 0),k([n.g],R.prototype,"syncId",void 0),k([n.g],R.prototype,"lastSyncTime",void 0),k([n.g],R.prototype,"syncSucsess",void 0),k([n.g],R.prototype,"syncFail",void 0),k([n.g],R.prototype,"syncFailMsg",void 0),k([n.g],R.prototype,"autosSyncList",void 0),k([n.g],R.prototype,"waitMergeData",void 0),k([n.g],R.prototype,"waitMergeId",void 0),k([n.g],R.prototype,"manualSyncList",void 0),k([n.g],R.prototype,"isRecovered",void 0),k([n.g],R.prototype,"recoverErrorTimes",void 0),k([n.g],R.prototype,"master",void 0),k([n.g],R.prototype,"prerender",void 0),k([n.g],R.prototype,"autoBackupPipe",void 0),k([n.e],R.prototype,"autoSyncing",null),k([n.b],R.prototype,"changeSyncSwitch",null),k([n.b],R.prototype,"autoBackup",null),k([n.b],R.prototype,"manualBackup",null),k([n.b],R.prototype,"toSync",null),k([n.b],R.prototype,"backupEnd",null),k([n.b],R.prototype,"downloadEnd",null),k([n.b],R.prototype,"syncEnd",null),k([n.b],R.prototype,"getSyncList",null),k([n.b],R.prototype,"getDetail",null),k([n.b],R.prototype,"tiggerBackup",null),k([n.b],R.prototype,"getV1RemoteData",null),k([n.b],R.prototype,"changeRecoveredStatus",null),k([n.b],R.prototype,"getAutoLatest",void 0),k([n.b],R.prototype,"pushAutoBackupPipe",null),k([n.b],R.prototype,"cleanupPipe",null),k([n.b],R.prototype,"changeSyncStatus",void 0);const E=new R;E.initSyncStore("store-sync",["autoBackupPipe","syncId","lastSyncTime","isOpenSync","isRecovered","recoverErrorTimes","prerender","waitMergeData","waitMergeId"],void 0,!0,50);Object(n.c)(()=>{var t;if(E.firstSync){const{isOpenSync:e,isRecovered:i,downloading:s}=E;if(m.userStore.isLogin&&e&&i&&!s&&!(null===(t=_.instance)||void 0===t?void 0:t.show)){const{data:t,websocketKeys:e,timestamp:i}=E.autoBackupPipe;(async t=>{const{data:e,websocketKeys:i,timestamp:s}=t,r=Object.assign({},e);if(Object.keys(r).length)try{const t=localStorage.getItem("lock-auto-backup");if(t&&Date.now()-Number(t)<4e3)return;localStorage.setItem("lock-auto-backup",""+Date.now()),0===E.autosSyncList.length?await o.a.all(L.map(async t=>{const e=await t.getBackupData();r[t.backupFileKey]=e})):await o.a.all(L.map(async t=>{if(i.includes(t.backupFileKey)){const e=await t.getBackupData();r[t.backupFileKey]=e}}));const{error:e}=await E.autoBackup(Object(n.j)(r),i.join(","));if(e)return;E.cleanupPipe(s),localStorage.removeItem("lock-auto-backup")}catch(t){}})({data:t,websocketKeys:e,timestamp:i})}}},{delay:4e3}),Object(n.c)(()=>{if(E.firstSync){const t=E.isOpenSync&&m.userStore.isLogin;C.slave.postTask("slave:change-sync",{status:t,userInfo:{uid:m.userStore.userInfo.uid,secret:m.userStore.userInfo.secret}}),t?E.autoRunGetAutoLatest():m.userStore.isLogin&&E.getSyncList()}},{delay:100}),Object(n.c)(()=>{E.firstSync&&(E.isOpenSync&&m.userStore.isLogin||(E.changeRecoveredStatus(!1),Object(n.i)(()=>{E.syncId="",E.waitMergeId=null,E.waitMergeData=null}),localStorage.removeItem("pre-sync-id")))}),Object(n.c)(()=>{E.firstSync&&m.userStore.isLogin&&0===m.userStore.userInfo["auto-backup"]&&0===E.autosSyncList.length&&d.a.restartAutoBackupReaction(!0)}),Object(n.c)(()=>{if(E.firstSync&&E.master){const t={downloading:E.downloading,backuping:E.backuping,syncSucsess:E.syncSucsess,syncFail:E.syncFail,syncFailMsg:E.syncFailMsg,isBackup:E.isBackup};C.slave.sendMessage("tabs-sync-status",t)}},{delay:20}),Object(n.c)(()=>{var t;E.firstSync&&E.autosSyncList.length&&(E.waitMergeId===(null===(t=E.autosSyncList[0])||void 0===t?void 0:t.id)?E.showModalAndCheckType():_.hide())},{delay:1}),window.addEventListener("beforeunload",()=>{E.master&&C.slave.sendMessage("tabs-sync-status",{downloading:!1,backuping:!1,syncSucsess:!1,syncFail:!1,syncFailMsg:"",isBackup:!1})}),Object(n.h)(()=>E.firstSync,async t=>{if(t){const t=await x();j.a.trySendStatus(t)}},{delay:1e3});const x=async()=>({currentIsLogin:!!m.userStore.isLogin,currentIsOpenSync:m.userStore.isLogin&&E.isOpenSync,currentSearchEngine:u.a.searchEngine.current.types[0].url.split("?")[0],currentWallpaper:(()=>{try{const t=h.a.type,e=["userLibraryAuto","cloudAuto"],i=["cloud","color"];if(["local","default","bing"].includes(t))return t;if(e.includes(t))return{[t]:h.a.switchType};if(i.includes(t))return"color"===t?{[t]:h.a.color}:{[t]:h.a.rawUrl}}catch(t){return"error"}})(),currentIconCount:(()=>{try{var t;const e=a()(t=d.a.sites).call(t,(t,e)=>{if(null==e?void 0:e.length){return t+a()(e).call(e,(t,e)=>{var i;return(null===(i=null==e?void 0:e.children)||void 0===i?void 0:i.length)?t+e.children.length:t+1},0)}return t},0);return 10*Math.round(e/10)}catch(t){return"error"}})(),currentVersion:O.C.extVersion,currentBrowserEnv:O.c,currentRunBrowser:O.C.runtimePlatform});j.a.sendPageView({page:"newtab"})},583:function(t,e,i){"use strict";i.d(e,"a",(function(){return W}));var s=i(105),o=i.n(s),r=i(582),a=i.n(r),n=i(48),l=i.n(n),c=i(7),d=i.n(c),p=(i(18),i(44),i(52),i(13),i(17),i(10),i(592),i(3)),u=i(243),h=i(246),y=i(122),g=i(0),m=i(593),b=i(589),f=i(178),w=i(346);function v(){f.slave.postTask("slave:bg-run-clear-wallpaper-timer-task")}async function I(t){let e;return e=await fetch(t).then(t=>t.blob()),e}var _=i(390),C=i(190),O=i(606),S=i.n(O),j=i(14),k=i(588),L=i(358),R=i(23),E=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a};const x=i(369);class U extends h.a{constructor(){super(),this.url=x,this.urlInUI=x,this.rawUrl=x,this.setWpSouceCount=t=>this.wpSourceCount=t,this.type="default",this.switchType="disabled",this.setSwitchType=t=>{this.switchType=t,this._updateTimer(!0)},this.setWpSourceCount=t=>this.wpSourceCount=t,this.wpExt="png",this.list=[],this.index=-1,this.timeEnd=0,this.remoteData=[],this.opacity=40,this.blur=0,this.setOpacity=t=>this.opacity=t,this.setBlur=t=>this.blur=t,this.liked=[],this.setLiked=t=>{this.liked=t},this.customColorItems=[],this.setCustomColorItems=t=>this.customColorItems=t,this._rgbaToHex=t=>{const e=t.replace(/rgba?\(/,"").replace(/\)/,"").replace(/[\s+]/g,"").split(","),i=parseFloat(e[3]||"1"),s=Math.floor(i*parseInt(e[0])+255*(1-i)),o=Math.floor(i*parseInt(e[1])+255*(1-i)),r=Math.floor(i*parseInt(e[2])+255*(1-i));return("0"+s.toString(16)).slice(-2)+("0"+o.toString(16)).slice(-2)+("0"+r.toString(16)).slice(-2)},this._maxCollectionlen=100,this.cloudCollection=[],this.appendCloudCollection=t=>this.cloudCollection.push(t),this.setCloudCollection=t=>this.cloudCollection=t,this._maxRecentUsedLen=100,this.cloudRecentUsedOrder={},this.setCloudRecentUsedOrder=t=>{const{cloudRecentUsedOrder:e,cloudRecentUsed:i}=this,s={};Object.keys(e).forEach(t=>{i.includes(t)&&(s[t]=e[t])}),s[t]=Date.now(),this.cloudRecentUsedOrder=s},this.cloudRecentUsed=[],this.setCloudRecentUsed=t=>{const e=Object.keys(this.cloudRecentUsedOrder);t.forEach(t=>{const i=e.indexOf(t);-1!==i&&e.splice(i,1)}),e.length>0&&e.forEach(t=>{delete this.localRecentUsedOrder[t]}),this.cloudRecentUsed=t},this.appendCloudRecentUsed=t=>{this.cloudRecentUsed.push(t),this.cloudRecentUsed=Array.from(new Set(this.cloudRecentUsed))},this.localRecentUsedOrder={},this.setLocalRecentUsedOrder=t=>{this.localRecentUsedOrder[t]=Date.now()},this.localRecentUsed=[],this.setLocalRecentUsed=t=>{const e=Object.keys(this.localRecentUsedOrder);t.forEach(t=>{const i=e.indexOf(t);-1!==i&&e.splice(i,1)}),e.length>0&&e.forEach(t=>{delete this.localRecentUsedOrder[t]}),this.localRecentUsed=t},this.appendLocalRecentUsed=t=>{this.localRecentUsed.push(t),this.localRecentUsed=Array.from(new Set(this.localRecentUsed))},this.isLibraryItem=t=>t.includes(window.__INFINITY__.wpLibraryItemId),this.isLocal=t=>t.includes(window.__INFINITY__.wpId),this.isColorItem=t=>t.includes(window.__INFINITY__.wpColorId),this.isCurrentWp=t=>this.id===t,this.diffRemote=t=>{const e=["type","switchType","timeEnd","id","wpSource","opacity","blur","customColorItems"],i=Object.keys(t).every(i=>!e.includes(i)||p.d.structural(this[i],t[i]));let s=!1;return"local"!==t.type&&t.url&&(s=this.urlInUI!==t.url),!i||s},this.nextPage=0,this.totalPage=-1,this.delay=-1,this._whenLocalSynced=()=>{const t=Object(u.e)(),e=!(this.isAuto&&!t.ready);switch(e&&this.stopAutoBackupReaction&&this.stopAutoBackupReaction(),t.type){case"local":this._setLocalAfterInit(t);break;case"cloudAuto":case"userLibraryAuto":this._setCloudAutoAfterInit(t);break;case"bing":case"color":case"cloud":break;case"default":default:this._setDefaultAfterInit(t)}switch(function(t){Object(p.c)(()=>{const{opacity:e,blur:i}=t,s={"--wallpaper-alpha":e/100,"--wallpaper-filter":i/5+"px"};Object.keys(s).forEach(t=>{document.body.style.setProperty(t,s[t])}),Object(u.j)({opacity:e,blur:i})},{delay:0}),Object(p.h)(()=>t.type,e=>{e.includes("Auto")||("bing"!==e?t.wpSource&&(t.wpSource=void 0):t.wpSource=e,t.switchType="disabled",v())}),Object(p.c)(()=>{const{id:e}=t;e&&t.addRecentUsedP(e)});const e=document.querySelector(".wallpaper");Object(p.h)(()=>[t.urlInUI,t.color],async([i,s])=>{if(s&&"color"===t.type)Object(u.h)(s);else if(i){await Object(u.c)(i)?e.style.backgroundColor?(Object(u.h)("#999"),setTimeout(()=>{Object(u.i)(i)},200)):Object(u.i)(i):t.setDefaultWallpaperRaw()}})}(this),t.type){case"bing":this._setBingAfterInit();break;case"userLibraryAuto":this._checkLibraryExists()}e&&this.restartAutoBackupReaction()},this._syncLock=!1,this.mergeRemote=async(t,e)=>{try{if(this._syncLock)return;if(this._syncLock=!0,!("type"in t))return;if(g.n&&delete t.blur,"cloudRecentUsed"in t){if(e)this.setCloudRecentUsed(t.cloudRecentUsed);else{const e=Array.from(new Set(t.cloudRecentUsed.concat(this.cloudRecentUsed)));this.setCloudRecentUsed(e)}delete t.cloudRecentUsed}if("customColorItems"in t&&(this.mergeCustomColor(this.customColorItems,t.customColorItems,e?2:0),delete t.customColorItems),"local"===t.type)return void await this._mergeLocal(t);t.urlInUI=t.url,this._merge(t),this._afterSynced()}catch(t){console.log(t)}finally{this._syncLock=!1}},this.windmillRotating=!1,this._windmillPrevRotateSpeed=0,this._windmillPrevRotateDegree=0,this._windmillPrevRotateTime=-1,this.performWindmillRotate=t=>{if(-1===this._windmillPrevRotateTime)return this._windmillPrevRotateTime=t,void requestAnimationFrame(this.performWindmillRotate);const e=t-this._windmillPrevRotateTime;let i=this._windmillPrevRotateDegree;const{_windmillPrevRotateSpeed:s}=this;let o=s,r=0;if(this.windmillRotating)if(s<.46){let t,i;o+=36e-5*e,o>.46?(i=(o-.46)/36e-5,t=e-i,o=.46):(t=e,i=0),r=.46*i+s*t+18e-5*t*t}else r=.46*e;else{let i;o-=36e-5*e,o<0?(i=s/36e-5,o=0):i=e,0===o&&(t=-1),r=s*i-18e-5*i*i}i-=r,i%=360,i<0&&(i=360+i),this.windmillParent&&this.windmillParent.rotateWindMill(i),this._windmillPrevRotateDegree=i,this._windmillPrevRotateTime=t,this._windmillPrevRotateSpeed=o,0!==o&&requestAnimationFrame(this.performWindmillRotate)},this._lockLoadRandomP=!1,this.needSwitchWallpaper=!1,this._afterWpAutoSwitched=()=>{this._updateTimer(!0),this._prepareNextWp()},this.timeToSwitchWallpaper=async()=>{await this.switchWallpaper(),this._afterWpAutoSwitched()},this.switchToNextWallpaper=async()=>{try{await this.timeToSwitchWallpaper()}catch(t){y.message.top(i18n("wallpaper_switch_failure"))}},this._lockLoadUserWpNeeded=!1,this._lockRollback=!0,this.initAutoBackup("wallpaper",["id","url","rawUrl","wpSource","wpSourceName","type","switchType","color","timeEnd","index","opacity","blur","cloudRecentUsed","cloudRecentUsedOrder","customColorItems","nextPage","totalPage","wpExt"]),async function(t){await t.initSyncStore("store-wallpaper",["id","urlInUI","rawUrl","wpSource","wpSourceCount","wpSourceName","type","switchType","imageName","imageSource","imageType","color","index","timeEnd","remoteData","opacity","blur","cloudRecentUsed","localRecentUsed","cloudRecentUsedOrder","localRecentUsedOrder","nextPage","totalPage","wpExt","customColorItems","delay"],void 0,!0)}(this).then(this._whenLocalSynced).finally(()=>{setTimeout(()=>{this._lockRollback=!1},30)}),setTimeout(()=>{this.windmillParent=document.querySelector("newtab-main")})}_updateTimer(t=!1){const{switchType:e}=this;if(["disabled","when-newtab"].includes(e))v(),this.setTimeEnd(0);else{if(t){const t=Date.now();this.setTimeEnd(t+Object(w.b)(e))}!function(t,e){const i=Date.now(),s=Object(w.b)(e),o=t.timeEnd;let r;o>i?r=o-i:(r=s,t.setTimeEnd(i+s)),f.slave.postTask("slave:bg-run-timer-to-switch-wallpaper",r)}(this,e)}}setWpSourceName(t){this.wpSourceName=t}setWallpaper(t){this.setWallpaperRaw(t);const e={};e.type=this.type,e.switchType=this.switchType,e.nextP=null,e.ready=!1,e.oneP=!1,Object(u.j)(e)}async setBase64Wallpaper(){const{type:t,url:e}=this;if(["local","color"].includes(t))return;const i=await Object(w.f)(e);await Object(u.g)(i)}setWallpaperRaw(t){const{url:e,urlInUI:i,rawUrl:s,id:o,name:r,source:a}=t;r&&(this.imageName=r),this.id=o,this.url=e,this.urlInUI=i,this.rawUrl=s,this.imageSource=a,Object(u.j)({currentP:t}),this.setBase64Wallpaper()}setColor(t){this.type="color",this.id=t.id,this.color=t.content,this.urlInUI=void 0;const e={};e.type=this.type,e.color=t.content,e.switchType="disabled",Object(u.j)(e)}setCloudWallpaper(t){this.type="cloud",this.setCloudWallpaperRaw(t)}setCloudWallpaperRaw(t){this.setWallpaper({type:t.type,id:t.id,url:t.url,urlInUI:t.url,rawUrl:t.rawUrl,source:t.source})}setAutoWallpaperRaw(t){this.setWallpaperRaw({type:t.type,id:t.id,url:t.url,urlInUI:t.url,rawUrl:t.rawUrl,source:t.source})}setWpExt(t){this.wpExt=t}async setLocalWallpaper(t){const{file:e}=t;this.setWpExt(S.a.getExtension(e.type));const i=await Object(w.f)(e);await Object(u.g)(i),this.setType("local"),this.setWallpaper({type:t.type,url:null,urlInUI:t.url,rawUrl:t.url,id:t.id})}async enableBingWallpaper(t){this.type="bing",this.wpSource="bing",this.setBingWallpaper(t)}setBingWallpaper(t){this.setCloudWallpaperRaw(t)}setList(t){this.list=t}pushList(t){this.list.push(...t)}setIndex(t){this.index=t}setTimeEnd(t){this.timeEnd=t,Object(u.j)({timeEnd:this.timeEnd})}setRemoteData(t){this.remoteData=t}pushRemoteData(t){this.remoteData.push(...t)}spliceRemoteData(t,e=0){this.remoteData.splice(e,t)}get isAuto(){return this.type.includes("Auto")}removeLiked(t){const e=this.liked.indexOf(t);-1!==e&&this.liked.splice(e,1)}addLiked(t){const e=Object(p.j)(this.liked);e.push(t);const i=Array.from(new Set(e));this.setLiked(i)}includeLiked(t){return this.liked.includes(t)}async loadCollectionP(){const t=await Object(C.getCollectionWallpaper)();t.error||this.setCloudCollection(t.data)}async loadLikedP(){const t=await Object(C.getLikedWallpaper)();t.error||this.setLiked(t.data)}pushCustomColor(t){this.customColorItems.push(...t)}includesColorItem(t){return-1!==this.customColorItems.findIndex(({content:e})=>t===e)}appendCustomColor(t){if(-1===this.customColorItems.findIndex(({content:e})=>e===t.content)){const e=Object(p.j)(this.customColorItems);this.setCustomColorItems([t].concat(e))}}removeCustomColor(t){const e=this.customColorItems.findIndex(({id:e})=>e===t);-1!==e&&this.customColorItems.splice(e,1)}_rgbToHex(t){var e;return o()(e=t.map(t=>t.toString(16).padStart(0))).call(e,(t,e)=>t+e)}async addCustomColorItem(t){if(this.includesColorItem(t))return;const e=this._rgbaToHex(t),i=window.__INFINITY__.color_list,s=i.map(t=>j.a.hexColorDelta(e,t)),o=i[s.indexOf(Math.max.apply(null,s))],r={id:`${window.__INFINITY__.wpColorId}${Object(k.a)()}`,content:t,similarColor:o};try{_.userStore.isLogin&&await Object(C.addCustomColor)(r),this.appendCustomColor(Object.assign({type:"color"},r)),L.default.success(i18n("add_success"))}catch(t){L.default.error(i18n("network_error"))}}addCloudCollectionP(t){if(this.cloudCollection.includes(t))return;this.appendCloudCollection(t);const e=this._maxCollectionlen-this.collectionLen;if(e<0){const t=Object(p.j)(this.cloudCollection).reverse();t.length+=e,this.setCloudCollection(t.reverse())}}removeCloudCollectionP(t){const e=this.cloudCollection.indexOf(t);-1!==e&&this.cloudCollection.splice(e,1)}get collectionLen(){return this.cloudCollection.length}removeCollectionP(t){this.removeCloudCollectionP(t)}addCollectionP(t){this.addCloudCollectionP(t)}includeCollection(t){return this.cloudCollection.includes(t)}async loadCollectP(){const{cloudCollection:t,customColorItems:e}=this,{commonColorItems:i}=b.a,s=[];if(0!==t.length){const o=[],r=[],a=[];if(t.forEach(t=>{this.isLibraryItem(t)?r.push(t):this.isColorItem(t)?a.push(t):o.push(t)}),o.length>0){const t=await Object(C.getWallpapersById)(o.join(","));if(t.error)throw t.error;s.push(...Object(w.a)(t.data))}if(r.length>0){const t=await Object(C.getUserWallpaperLibraryItemsById)(r.join(","));if(t.error)throw t.error;s.push(...m.a.mapUploadWallpapers(t.items))}a.length>0&&a.forEach(t=>{let o=i.find(({id:e})=>e===t);o||(o=e.find(({id:e})=>e===t)),o&&s.push(o)})}return s}dropCloudRecentUsed(t){const e=this.cloudRecentUsed.indexOf(t);-1!==e&&this.cloudRecentUsed.splice(e,1)}get recentUsedLen(){return this.cloudRecentUsed.length+this.localRecentUsed.length}addLocalRecentP(t){if(this.setLocalRecentUsedOrder(t),this.localRecentUsed.includes(t))return;this.appendLocalRecentUsed(t);const e=this._maxRecentUsedLen-this.recentUsedLen;if(e<0){const t=Object(p.j)(this.localRecentUsed).reverse();t.length+=e,this.setLocalRecentUsed(t.reverse())}}addCloudRecentP(t){if(this.setCloudRecentUsedOrder(t),this.cloudRecentUsed.includes(t))return;this.appendCloudRecentUsed(t);const e=this._maxRecentUsedLen-this.recentUsedLen;if(e<0){const t=Object(p.j)(this.cloudRecentUsed).reverse();t.length+=e,this.setCloudRecentUsed(t.reverse())}}removeCloudRecentUsedP(t){const e=Object(p.j)(this.cloudRecentUsed);t.forEach(t=>{const i=e.indexOf(t);-1!==i&&e.splice(i,1)}),this.setCloudRecentUsed(e)}addRecentUsedP(t){this.addCloudRecentP(t)}_getItemTime(t){return"local"===t.type?this.localRecentUsedOrder[t.id]:["cloud","color"].includes(t.type)?this.cloudRecentUsedOrder[t.id]:void 0}async loadRecentUsedP(){const{localRecentUsed:t,cloudRecentUsed:e,customColorItems:i}=this,{localItems:s,commonColorItems:o}=b.a,r=[];if(0!==e.length){const t=[],s=[],a=[];if(e.forEach(e=>{this.isLibraryItem(e)?s.push(e):this.isColorItem(e)?a.push(e):t.push(e)}),t.length>0){const e=await Object(C.getWallpapersById)(t.join(","));if(e.error)throw e.error;r.push(...Object(w.a)(e.data))}if(s.length>0){const t=await Object(C.getUserWallpaperLibraryItemsById)(s.join(","));if(t.error)throw t.error;r.push(...m.a.mapUploadWallpapers(t.items))}a.length>0&&a.forEach(t=>{let e=o.find(({id:e})=>e===t);e||(e=i.find(({id:e})=>e===t)),e&&r.push(e)})}return a()(r).call(r,(t,e)=>{const i=this._getItemTime(t),s=this._getItemTime(e);return i>s?-1:i<s?1:0}),r}async getBackupData(){const t={};this.backupValueKeys.forEach(e=>{t[e]=Object(p.j)(this[e])});try{if("local"===this.type){const e=await Object(u.d)();t.url=e}else t.url=this.urlInUI}catch(e){t.type="default"}return t}async modifyUserLibrary(t){if(t!==this.wpSource)return;const e=m.a.customLibraryMap[t],i=e.findIndex(({_id:t})=>t===this.id),s=Object(u.e)(),{nextP:o}=s;(-1===e.findIndex(({_id:t})=>t===o.id)||e.length>1&&s.oneP)&&(s.nextP=null,s.ready=!1,s.oneP=!1,Object(u.j)(s)),-1===i&&await this.timeToSwitchWallpaper()}_setDefaultAfterInit(t){}_setLocalAfterInit({currentP:t}){this.rawUrl=this.urlInUI=t.rawUrl}_setCloudAutoAfterInit(t){t.ready?this._updateTimer(!0):(this.setAutoWallpaperRaw(t.currentP),this._afterWpAutoSwitched())}async _setBingAfterInit(){const t=await Object(w.c)();this.id!==t.id&&this.setCloudWallpaperRaw(t)}setDefaultWallpaperRaw(){this.id=null,this.urlInUI=this.url=u.b,this.rawUrl=u.a}setDefaultWallpaper(){this.id=null,this.type="default",this.urlInUI=this.url=u.b,this.rawUrl=u.a;const t=Object(u.e)();t.oneP=!1,t.ready=!1,t.currentP={id:null,url:u.b,urlInUI:u.b,rawUrl:u.a},t.type="default",t.switchType="disabled",Object(u.j)(t)}async _checkLibraryExists(){try{const t=await Object(C.hasWallpaperLibrary)(this.wpSource);if(t.error)throw t.error;1!==t.data&&this.setDefaultWallpaper()}catch(t){}}setType(t){this.type=t}_merge(t){Object.keys(t).forEach(e=>{this[e]!==t[e]&&(this[e]=t[e])})}async _mergeLocal(t){if("local"===this.type&&this.urlInUI.startsWith("blob:")){if(await Object(u.d)()!==t.url){const e=await I(t.url);t.urlInUI=t.rawUrl=l.a.createObjectURL(e),await Object(u.g)(t.url)}else t.urlInUI=null,t.rawUrl=null}else{const e=await I(t.url);t.urlInUI=t.rawUrl=l.a.createObjectURL(e),await Object(u.g)(t.url)}t.url=null;const e=t.wpExt;delete t.wpExt,this._merge(t),t.id?this.setWpExt(e):this.setWpExt(""),this._afterSynced()}async mergeCustomColor(t,e,i,s=!1){switch(i){case 1:if(0===t.length)return;await Object(C.setCustomColorItems)(t.map(t=>(delete t.type,t)));break;case 2:W.setCustomColorItems(e.map(t=>(t.type="color",t)));break;case 0:{const i=[],o=[];for(let e=0,s=t.length;e<s;++e){const s=t[e];o.includes(s.id)||(i.push(s),o.push(s.id))}for(let t=0,s=e.length;t<s;++t){const s=e[t];o.includes(s.id)||(i.push(s),o.push(s.id))}s&&await Object(C.setCustomColorItems)(i.map(t=>(delete t.type,t))),W.setCustomColorItems(i.map(t=>("type"in t||(t.type="color"),t)))}}}_afterSynced(){R.c&&Object(p.i)(()=>{this.url=this.url.replace(u.l,""),this.urlInUI=this.urlInUI.replace(u.l,"")});const t={currentP:{id:this.id,url:this.url,urlInUI:this.urlInUI,rawUrl:this.rawUrl}};t.type=this.type,t.color=this.color,t.switchType=this.switchType,t.timeEnd=this.timeEnd,t.opacity=this.opacity,t.blur=this.blur,t.ready=!1,t.oneP=!1,t.nextP=null,Object(u.j)(t),this.setBase64Wallpaper(),this.isAuto&&(this._updateTimer(),this._prepareNextWp())}startRotateWindmill(){this.windmillRotating=!0,0===this._windmillPrevRotateSpeed&&requestAnimationFrame(this.performWindmillRotate)}endRotateWindmill(){this.windmillRotating=!1}async randomWallpaper(){if(!this._lockLoadRandomP){this._lockLoadRandomP=!0,this.startRotateWindmill();try{const{data:t,error:e}=await Object(C.getRandomWallpaper)();if(e)throw new Error(JSON.stringify(e));const i=await Object(u.c)(t.url);if(!i)throw new Error("fetch res to check :"+i);this.setCloudWallpaper(Object.assign({type:"cloud"},t)),y.message.top(i18n("wallpaper_switch_success"))}catch(t){y.message.top(i18n("wallpaper_switch_failure"))}finally{this._lockLoadRandomP=!1,this.endRotateWindmill()}}}async getNextWp(...t){const{data:e}=await Object(C.getNextWallpaper)(...t),[i]=Object(w.a)([e]);return i}async _prepareNextWp(){if(Object(u.e)().oneP)return;const t="userLibraryAuto"!==this.type?"library":"userLibrary",e=await this.getNextWp(this.wpSource,this.id,t);Object(u.c)(e.url).catch(()=>{});const i={};e.id===this.id?i.oneP=!0:i.oneP=!1,i.nextP=e,i.ready=!0,Object(u.j)(i)}enableUserLibraryAuto({libraryId:t,libraryName:e},i,s){this.type="userLibraryAuto",this.switchType=i,this.wpSource=t,this.wpSourceName=e,this._afterEnableWpAuto(s)}enableCloudAuto(t,e,i){this.type="cloudAuto",this.wpSource=t,this.switchType=e,this._afterEnableWpAuto(i)}_afterEnableWpAuto(t){this.setAutoWallpaperRaw(t);const e={currentP:t};e.type=this.type,e.switchType=this.switchType,e.timeEnd=this.timeEnd,e.ready=!1,e.oneP=!1,e.nextP=null,Object(u.j)(e),this._afterWpAutoSwitched()}async switchWallpaper(){Object(u.e)().ready||await this._prepareNextWp();const t=Object(u.e)();this.setAutoWallpaperRaw(t.nextP),Object(u.j)({ready:!1,nextP:null})}releaseLockLoadUserWp(){this._lockLoadUserWpNeeded=!1}lockLoadUserWp(){this._lockLoadUserWpNeeded=!0}loadUserWpNeededRaw(){const t=[];return this._lockLoadUserWpNeeded||t.push(m.a.loadUserWallpaperLibrary(),W.loadCollectionP(),W.loadLikedP()),d.a.all(t)}}E([p.g],U.prototype,"id",void 0),E([p.g],U.prototype,"url",void 0),E([p.g],U.prototype,"urlInUI",void 0),E([p.g],U.prototype,"rawUrl",void 0),E([p.g],U.prototype,"wpSource",void 0),E([p.g],U.prototype,"wpSourceCount",void 0),E([p.b],U.prototype,"setWpSouceCount",void 0),E([p.g],U.prototype,"type",void 0),E([p.g],U.prototype,"switchType",void 0),E([p.b],U.prototype,"setSwitchType",void 0),E([p.b],U.prototype,"setWpSourceCount",void 0),E([p.g],U.prototype,"wpSourceName",void 0),E([p.b],U.prototype,"setWpSourceName",null),E([p.g],U.prototype,"imageName",void 0),E([p.g],U.prototype,"imageSource",void 0),E([p.g],U.prototype,"imageType",void 0),E([p.b],U.prototype,"setWallpaper",null),E([p.b],U.prototype,"setWallpaperRaw",null),E([p.g],U.prototype,"color",void 0),E([p.b],U.prototype,"setColor",null),E([p.b],U.prototype,"setCloudWallpaper",null),E([p.b],U.prototype,"setCloudWallpaperRaw",null),E([p.b],U.prototype,"setAutoWallpaperRaw",null),E([p.g],U.prototype,"wpExt",void 0),E([p.b],U.prototype,"setWpExt",null),E([p.b],U.prototype,"enableBingWallpaper",null),E([p.b],U.prototype,"setBingWallpaper",null),E([p.g],U.prototype,"list",void 0),E([p.b],U.prototype,"setList",null),E([p.b],U.prototype,"pushList",null),E([p.g],U.prototype,"index",void 0),E([p.b],U.prototype,"setIndex",null),E([p.g],U.prototype,"timeEnd",void 0),E([p.b],U.prototype,"setTimeEnd",null),E([p.g],U.prototype,"remoteData",void 0),E([p.b],U.prototype,"setRemoteData",null),E([p.b],U.prototype,"pushRemoteData",null),E([p.b],U.prototype,"spliceRemoteData",null),E([p.g],U.prototype,"opacity",void 0),E([p.g],U.prototype,"blur",void 0),E([p.b],U.prototype,"setOpacity",void 0),E([p.b],U.prototype,"setBlur",void 0),E([p.e],U.prototype,"isAuto",null),E([p.g],U.prototype,"liked",void 0),E([p.b],U.prototype,"setLiked",void 0),E([p.b],U.prototype,"removeLiked",null),E([p.b],U.prototype,"addLiked",null),E([p.g],U.prototype,"customColorItems",void 0),E([p.b],U.prototype,"setCustomColorItems",void 0),E([p.b],U.prototype,"pushCustomColor",null),E([p.b],U.prototype,"removeCustomColor",null),E([p.b],U.prototype,"addCustomColorItem",null),E([p.g],U.prototype,"cloudCollection",void 0),E([p.b],U.prototype,"appendCloudCollection",void 0),E([p.b],U.prototype,"setCloudCollection",void 0),E([p.b],U.prototype,"addCloudCollectionP",null),E([p.b],U.prototype,"removeCloudCollectionP",null),E([p.e],U.prototype,"collectionLen",null),E([p.g],U.prototype,"cloudRecentUsed",void 0),E([p.b],U.prototype,"dropCloudRecentUsed",null),E([p.b],U.prototype,"setCloudRecentUsed",void 0),E([p.b],U.prototype,"appendCloudRecentUsed",void 0),E([p.g],U.prototype,"localRecentUsed",void 0),E([p.b],U.prototype,"setLocalRecentUsed",void 0),E([p.b],U.prototype,"appendLocalRecentUsed",void 0),E([p.e],U.prototype,"recentUsedLen",null),E([p.b],U.prototype,"addLocalRecentP",null),E([p.b],U.prototype,"addCloudRecentP",null),E([p.b],U.prototype,"removeCloudRecentUsedP",null),E([p.b],U.prototype,"modifyUserLibrary",null),E([p.g],U.prototype,"delay",void 0),E([p.b],U.prototype,"_setDefaultAfterInit",null),E([p.b],U.prototype,"_setLocalAfterInit",null),E([p.b],U.prototype,"_setCloudAutoAfterInit",null),E([p.b],U.prototype,"setDefaultWallpaperRaw",null),E([p.b],U.prototype,"setDefaultWallpaper",null),E([p.b],U.prototype,"setType",null),E([p.b],U.prototype,"_merge",null),E([p.b],U.prototype,"mergeRemote",void 0),E([p.b],U.prototype,"randomWallpaper",null),E([p.b],U.prototype,"enableUserLibraryAuto",null),E([p.b],U.prototype,"enableCloudAuto",null),E([p.b],U.prototype,"switchWallpaper",null);const W=new U;Object(p.h)(()=>W.wpSource,t=>m.a.setPSource(t),{fireImmediately:!0}),Object(p.h)(()=>_.userStore.isLogin,t=>{t||(W.setCloudCollection([]),W.setLiked([]),W.releaseLockLoadUserWp(),m.a.setCustomLibrary([]),m.a.clearCustomLibraryMap())})},584:function(t,e,i){"use strict";i.r(e),i.d(e,"weatherStore",(function(){return w})),i.d(e,"getCurrentWeather",(function(){return v}));var s=i(7),o=i.n(s),r=i(582),a=i.n(r),n=(i(13),i(17),i(10),i(3)),l=i(81),c=i(14),d=i(246),p=i(0);const u={100:i18n("w_100"),101:i18n("w_101"),102:i18n("w_102"),103:i18n("w_103"),104:i18n("w_104"),200:i18n("w_200"),201:i18n("w_201"),202:i18n("w_202"),203:i18n("w_203"),204:i18n("w_204"),205:i18n("w_205"),206:i18n("w_206"),207:i18n("w_207"),208:i18n("w_208"),209:i18n("w_209"),210:i18n("w_210"),211:i18n("w_211"),212:i18n("w_212"),213:i18n("w_213"),300:i18n("w_300"),301:i18n("w_301"),302:i18n("w_302"),303:i18n("w_303"),304:i18n("w_304"),305:i18n("w_305"),306:i18n("w_306"),307:i18n("w_307"),308:i18n("w_308"),309:i18n("w309"),310:i18n("w_310"),311:i18n("w_311"),312:i18n("w_312"),313:i18n("w_313"),314:i18n("w_314"),315:i18n("w_315"),316:i18n("w_316"),317:i18n("w_317"),318:i18n("w_318"),399:i18n("w_399"),400:i18n("w_400"),401:i18n("w_401"),402:i18n("w_402"),403:i18n("w_403"),404:i18n("w_404"),405:i18n("w_405"),406:i18n("w_406"),407:i18n("w_407"),408:i18n("w_408"),409:i18n("w_409"),410:i18n("w_410"),499:i18n("w_499"),500:i18n("w_500"),501:i18n("w_501"),502:i18n("w_502"),503:i18n("w_503"),504:i18n("w_504"),507:i18n("w_507"),508:i18n("w_508"),509:i18n("w_509"),510:i18n("w_510"),511:i18n("w_511"),512:i18n("w_512"),513:i18n("w_513"),514:i18n("w_514"),515:i18n("w_515"),900:i18n("w_900"),901:i18n("w_901"),999:i18n("w_999")},h={alyBGColor(t){let e="#36B3FF";switch(t.conditionCode){case"100":case"101":case"102":case"103":case"104":e="#0F7CFF";break;case"200":case"201":case"202":case"203":case"204":case"205":case"206":e="#10BDFF";break;case"207":case"208":case"209":case"210":case"211":case"212":e="#096BB2";break;case"213":case"900":e="#FF7F3B";break;case"300":case"301":case"302":case"303":case"304":case"305":case"306":case"307":case"308":case"309":case"310":case"311":case"312":case"313":case"314":case"315":case"316":case"317":case"318":case"399":e="#427BD1";break;case"301":case"300":case"402":case"403":case"404":case"405":case"406":case"407":case"408":case"409":case"410":case"4991":e="#87A6D5";break;case"500":case"501":case"502":case"503":case"504":case"505":case"506":case"507":case"508":case"509":case"510":case"511":case"512":case"513":case"514":case"515":case"999":e="#98A6BD";break;default:e="#0441C5"}return e},alyWIcon:t=>`${p.a}/weather/code_${t.conditionCode}.png`,alyText:t=>u[t.conditionCode]};function y(t,e,i){let s,o;return"celsius"===e?(s=t,o="°C"):(s=Math.floor(1.8*t+32),o="°F"),i&&(s+=o),s}var g=i(247),m=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a},b=function(t,e){var i={};for(var s in t)Object.prototype.hasOwnProperty.call(t,s)&&e.indexOf(s)<0&&(i[s]=t[s]);if(null!=t&&"function"==typeof Object.getOwnPropertySymbols){var o=0;for(s=Object.getOwnPropertySymbols(t);o<s.length;o++)e.indexOf(s[o])<0&&Object.prototype.propertyIsEnumerable.call(t,s[o])&&(i[s[o]]=t[s[o]])}return i};class f extends d.a{constructor(){super(...arguments),this.localData={},this.list=[],this.lastUpdated=+new Date,this.unit="celsius",this.isShowModal=!1,this.isShowSetting=!1,this.searchState="none",this.citys=[]}get formateList(){return this.list.filter(t=>t.items).map(t=>{var e=b(t,[]);return e.items=e.items.map((t,e)=>{var i=b(t,[]);return 0===e&&(i._bgColor=h.alyBGColor(i),i._text=h.alyText(i)),i._bgImg=h.alyWIcon(i),i}),e})}sortList(t){this.list=t}changeIndex(t,e){var i;if(t===e)return;let s=[...this.list];const o=s.findIndex(e=>e.cid===t);if(-1===o)return;if("bottom"===e){const[t]=s.splice(o,1);s.push(t)}else if("top"===e){const[t]=s.splice(o,1);s.unshift(t)}else{const t=s.findIndex(t=>t.cid===e);if(-1===t)return;const[i]=s.splice(o,1);s.splice(t,0,i)}const r=(null===(i=this.list.filter(t=>t.top)[0])||void 0===i?void 0:i.name)||"";(r===t||r===e)&&(s=this.list.map(t=>t.top?Object.assign(Object.assign({},t),{top:0}):t)),this.list=s}openModal(){this.isShowModal=!0}closeModal(){this.isShowModal=!1,this.searchCitys("")}updateList(t){this.list=t}diffRemote(t){var e;if((null===(e=null==t?void 0:t.list)||void 0===e?void 0:e.length)!==this.list.length)return!0;if(this.unit!==t.unit)return!0;return this.list.some((e,i)=>e.cid!==t.list[i].cid)}async mergeRemote(t,e){if(t.list)try{const i=await this.getWeatherByCid(t.list);Object(n.i)(()=>{if(this.unit=t.unit,e)this.list=i;else{const t=this.list,e=i,{result:s}=c.a.mergeArray(t,e,"cid","updateTime");this.list=s}})}catch(t){}}async getWeatherByCid(t){t=t.filter(t=>t.name&&t.cid&&t.items);return await o.a.all(t.map(async t=>{if(t.cid){const e=await l.i.getForecastWeather(t.cid);if(null==e?void 0:e.data){return Object.assign(Object.assign({},e.data),{name:t.name})}}}))}async initLocal(){const t=await l.i.getLocalCity();Object(n.i)(()=>{t&&(this.localData=t.data)})}async addCity(t,e){const{data:i}=await l.i.getForecastWeather(t);if(!i)throw new Error(i18n("no_current_city_weather_data"));Object(n.i)(()=>{for(const e in this.list)if(this.list[e].cid===t)throw new Error(i18n("repeat_city"));this.list.push(Object.assign(Object.assign({},i),{cid:t,name:e})),this.lastUpdated=+new Date,this.closeModal()})}async searchCitys(t){if(!t)return this.citys=[],void(this.searchState="none");this.searchState="ing";try{const{data:e}=await l.i.getCityList(t);e?Object(n.i)(()=>{if(200===e.status){this.searchState="done";const t=e.cities.filter(t=>!this.filterCity(t.cid));this.citys=t}}):Object(n.i)(()=>{this.searchState="error"})}catch(t){Object(n.i)(()=>{this.searchState="error"})}}filterCity(t){const e=t.substr(t.length-1);return/^[a-zA-Z]+$/.test(e)}changeSelected(t,e){this.citys[t].selected=e}deleteCityWeather(t){let e=-1;for(const i in this.list)t===this.list[i].cid&&(e=Number(i));this.list.splice(e,1),this.lastUpdated=+new Date}changeUnit(){this.unit="celsius"===this.unit?"fahrenheit":"celsius",g.a.sendEvent({settingAction:{weatherUnit:this.unit}})}toggleSetting(){this.isShowSetting=!this.isShowSetting}closeSetting(){this.isShowSetting=!1}reset(){this.isShowSetting=!1,this.isShowModal=!1}toTop(t,e){var i;this.list=a()(i=this.list.map(i=>i.cid===t?Object.assign(Object.assign({},i),{top:0===e?1:0}):Object.assign(Object.assign({},i),{top:0}))).call(i,(t,e)=>e.top-t.top)}toggleOpen(t){this.list=this.list.map(e=>e.cid===t?Object.assign(Object.assign({},e),{open:0===e.open?1:0}):Object.assign({},e))}}m([n.g],f.prototype,"localData",void 0),m([n.g],f.prototype,"list",void 0),m([n.g],f.prototype,"lastUpdated",void 0),m([n.g],f.prototype,"unit",void 0),m([n.g],f.prototype,"isShowModal",void 0),m([n.g],f.prototype,"isShowSetting",void 0),m([n.g],f.prototype,"searchState",void 0),m([n.g],f.prototype,"citys",void 0),m([n.e],f.prototype,"formateList",null),m([n.b],f.prototype,"sortList",null),m([n.b],f.prototype,"changeIndex",null),m([n.b],f.prototype,"openModal",null),m([n.b],f.prototype,"closeModal",null),m([n.b],f.prototype,"updateList",null),m([n.b],f.prototype,"mergeRemote",null),m([n.b],f.prototype,"addCity",null),m([n.b],f.prototype,"searchCitys",null),m([n.b],f.prototype,"changeSelected",null),m([n.b],f.prototype,"deleteCityWeather",null),m([n.b],f.prototype,"changeUnit",null),m([n.b],f.prototype,"toggleSetting",null),m([n.b],f.prototype,"closeSetting",null),m([n.b],f.prototype,"reset",null),m([n.b],f.prototype,"toTop",null),m([n.b],f.prototype,"toggleOpen",null);const w=new f;w.initSyncStore("store-weather",["localData","list","unit","lastUpdated"],{},!0),w.initAutoBackup("weather",["list","unit"]);const v=()=>{const t=w.formateList[0],e=null==t?void 0:t.items[0];if(!e)return{};return{name:y(e.tmpMax,w.unit,!0),bgColor:e._bgColor,bgImg:e._bgImg}};Object(n.c)(()=>{w.list.some(t=>!t||!t.cid)&&(p.j&&alert("error"),Object(n.i)(()=>{w.list=w.list.filter(t=>(null==t?void 0:t.name)&&(null==t?void 0:t.cid)&&(null==t?void 0:t.items))}))})},585:function(t,e,i){"use strict";i.d(e,"a",(function(){return v}));var s=i(105),o=i.n(s),r=i(582),a=i.n(r),n=(i(13),i(17),i(52),i(10),i(260),i(18),i(3)),l=i(368),c=i.n(l),d=i(246),p=i(391),u=i(14),h=i(0),y=i(194),g=i(392),m=i(584),b=i(81),f=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a};class w extends d.a{constructor(){super(...arguments),this.sites=Object(y.f)(h.C.lang),this.editingId=null,this.currentPageIndex=0,this.redirectVersion="",this.mergeSiteArray=(t,e,i)=>{const s=t=>{if("object"==typeof t){if(t.target===y.j.target){const e=["target","uuid"];return o()(e).call(e,(e,i)=>e+t[i],"")}{var e;const i=a()(e=Object.keys(t).filter(t=>"id"!==t&&"updatetime"!==t)).call(e);return o()(i).call(i,(e,i)=>e+t[i],"")}}},r=(t=>{const e=Object.create(null),i=t=>{t.forEach(t=>{var s;if(Array.isArray(t))i(t);else if(t&&t.id){const o=t.id;e[o]=t,(null===(s=t.children)||void 0===s?void 0:s.length)>0&&i(t.children)}})};return i(t),e})(e),n=(t=>{const e=Object.create(null),i=t=>{t.forEach(t=>{var o;if(Array.isArray(t))i(t);else if("object"==typeof t)if((null===(o=t.children)||void 0===o?void 0:o.length)>0)i(t.children);else{const i=s(t);e[i]=!0}})};return i(t),e})(e);let l=!1;t.forEach((e,i)=>{t[i]=e.filter(t=>{var e;const i=r[t.id],o=t.updatetime||0;if((null===(e=t.children)||void 0===e?void 0:e.length)>0){if(i){return o>(i.updatetime||0)&&(l=!0,i.name=t.name),t.children.forEach(t=>{if(r[t.id]){const e=r[t.id].updatetime||0;(t.updatetime||0)>e&&(l=!0,Object.assign(r[t.id],t))}else l=!0,i.children.push(t)}),!1}return t.children=t.children.filter(t=>{if(r[t.id]){const e=r[t.id].updatetime||0;return(t.updatetime||0)>e&&(l=!0,Object.assign(r[t.id],t)),!1}return!0}),0!==t.children.length&&(1===t.children.length&&(Object.assign(t,t.children[0]),delete t.children),!0)}{if(!t.updatetime)return!1;const e=s(t);if(n[e])return!1;if(i){return o>(i.updatetime||0)&&(l=!0,Object.assign(r[t.id],t)),!1}return!0}})});const c=[];if(t.forEach(t=>{t.forEach(t=>{c.push(t)})}),c.length>0&&e.length>0){l=!0;let t=e.length-1;c.forEach(s=>{e[t].length<i?e[t].push(s):(t+=1,e[t]=[s])})}return{result:e,isLocalEffective:l}},this.convertBackupEquals=t=>{const{sites:e}=t;return(null==e?void 0:e.length)&&e.forEach(t=>{(null==t?void 0:t.length)&&t.forEach(t=>{(null==t?void 0:t.uuid)===y.j.uuid?(t.name=void 0,t.bgColor=void 0,t.bgImage=void 0):(null==t?void 0:t.children)&&t.children.forEach(t=>{(null==t?void 0:t.uuid)===y.j.uuid&&(t.name=void 0,t.bgColor=void 0,t.bgImage=void 0)})})}),t}}get uids(){const t=new Set;return(g.pluginStore.pluginViews.includes("infinity://settings")||g.pluginStore.pluginViews.includes("profile"))&&this.sites.forEach(e=>{e.filter(t=>t).forEach(e=>{e.children?e.children.forEach(e=>{t.add(e.uuid+"#"+e.target)}):t.add(e.uuid+"#"+e.target)})}),t}changeCurrentPage(t){this.currentPageIndex=t}diffRemote(t){const e=t=>{if((null==t?void 0:t.target)===y.j.target){const e={name:void 0,bgColor:void 0,bgImage:void 0};return Object.assign(Object.assign({},t),e)}},i=c()(t.sites||[],e),s=c()(Object(n.j)(this.sites),e);return!n.d.structural(i,s)}mergeRemote(t,e){if(!t.sites)return;const i=Object(m.getCurrentWeather)();if(e)this.setWeatherIcon(t.sites,i),this.sites=t.sites;else{const{col:e,row:s}=p.b.setting.layout,o=e*s,{result:r}=this.mergeSiteArray(Object(n.j)(this.sites),t.sites,o);this.setWeatherIcon(r,i),this.sites=r}this.sites.length?this.sites.length-1<this.currentPageIndex&&document.querySelector("newtab-main").toPage(this.sites.length-1):this.currentPageIndex=0}clearEditSite(){this.editingId=null}setEditSite(t){this.editingId=t}delSites(t=[],e=!0){var i,s,o;const[r,a,n]=t;let l,c=null;return 2===t.length?l=this.sites[r].splice(a,1):3===t.length&&(l=null===(s=null===(i=this.sites[r][a])||void 0===i?void 0:i.children)||void 0===s?void 0:s.splice(n,1)),e&&this.finishingSites(t[0]),2===t.length&&0===(null===(o=this.sites[r])||void 0===o?void 0:o.length)&&(c=r),{data:l,clearPageIndex:c}}insertSite(t=[],e){var i,s;const[o,r,a]=t;2===t.length?this.sites[o].splice(r,0,e):3===t.length&&(null===(s=null===(i=this.sites[o][r])||void 0===i?void 0:i.children)||void 0===s||s.splice(a,0,e))}handelStatus(t,e,i,s,o){const[r]=t;let[a]=e;if(null!==o&&o<a&&(a-=1,document.querySelector("newtab-main")._toPrevPage(!0)),3===t.length&&i.children.length<2){const t=this.findIndex(r,i.id);this.destroyFolder(t),a-=1}const n=null!==o?Math.min(o,a):a;return this.finishingSites(Math.max(n,0)),this.findIndex(a,s.id)}findIndex(t,e){const i=[];for(let s=Math.max(t||0,0);s<this.sites.length;s++){const t=this.sites[s];i[0]=s;if(t.find((t,s)=>t.id===e?(i[1]=s,!0):!!t.children&&t.children.find((t,o)=>t.id===e&&(i[1]=s,i[2]=o,!0))))return i}}findIcon(t,e){let i={};for(let s=Math.max(t||0,0);s<this.sites.length;s++){if(this.sites[s].some(t=>t.id===e?(i=t,!0):!!t.children&&t.children.some(t=>t.id===e&&(i=t,!0))))return i}return i}destroyFolder(t){const[e,i]=t,s=this.sites[e][i].children;0===s.length?this.sites[e].splice(i,1):(this.sites[e][i]=s.shift(),s.length>0&&this.sites[e].push(...s))}manualDestroyFolder(t){const[e,i]=t,s=this.sites[e][i].children;this.sites[e].splice(i,1);const{col:o,row:r}=p.b.setting.layout,a=o*r-this.sites[e].length;if(a>=s.length)this.sites[e].push(...s);else{const t=s.splice(0,a);this.sites[e].push(...t);const i=this.sites.length-1;this.sites[i].push(...s),this.finishingSites(i)}}finishingSites(t=0){const{col:e,row:i}=p.b.setting.layout,s=e*i,o=t=>{if(this.sites.length<=t)return;const e=this.sites[t].length;if(e>s){const i=t+1,r=this.sites[t].splice(s,e-s);this.sites.length>i?this.sites[i].unshift(...r):this.sites.push(r),o(i)}else 0===e?(t&&t===this.sites.length-1&&document.querySelector("newtab-main").toPage(t-1),this.sites.splice(t,1),o(t)):o(t+1)};o(t);for(let t=0;t<this.sites.length;){const e=this.sites[t];e&&e.length||(this.sites.splice(t,1),t-=1),t+=1}}reSort(t,e){var i;const s=t*e,r=o()(i=this.sites).call(i,(t,e)=>t.concat(e),[]),a=Array(Math.ceil(r.length/s)).fill(null);this.sites=a.map((t,e)=>r.slice(e*s,(e+1)*s))}addSite(t,e=0){if(this.sites.length>e){const{col:i,row:s}=p.b.setting.layout,o=i*s;return this.sites[e].length<o?(this.sites[e].push(t),e):this.addSite(t,e+1)}return this.sites[e]=[t],e}isIcon(t,e){return!this.findIcon(t,e).children}changeFolderName(t,e){const[i,s]=t;this.sites[i][s].name=e,this.sites[i][s].updatetime=Date.now()}setWeatherIcon(t,e){t.forEach(t=>{t&&t.forEach(t=>{t.target===y.j.target&&(t.name=e.name||y.j.name,t.bgColor=e.bgColor||y.j.bgColor,t.bgImage=e.bgImg||y.j.bgImage),t.children&&t.children.forEach(t=>{t.target===y.j.target&&(t.name=e.name||y.j.name,t.bgColor=e.bgColor||y.j.bgColor,t.bgImage=e.bgImg||y.j.bgImage)})})})}async submitSite(t){if("color"===t.bgType?delete t.bgImage:"image"===t.bgType&&(delete t.bgFont,delete t.bgText,delete t.bgColorImage,"transparent"===t.bgColor&&(t.bgColor=void 0)),t.updatetime=await u.a.getTimestamp(),this.editingId){const e=this.findIcon(this.currentPageIndex,this.editingId);let i={};Object(n.i)(()=>{if(i=Object.assign(e,t),i.target===y.j.target){const t=Object(m.getCurrentWeather)();this.setWeatherIcon(v.sites,t)}})}else{const e=Object.assign({uuid:u.a.randomId("site-"),id:u.a.randomId("siteId-"),type:"web"},t),i=v.addSite(e,this.currentPageIndex);if(e.target===y.j.target){const t=Object(m.getCurrentWeather)();this.setWeatherIcon(v.sites,t)}document.querySelector("newtab-main").toPage(i)}return null}async getRedirectTargets(){const{data:t,error:e}=await b.b.getRedirectTargets(this.redirectVersion);if(!e&&t){const{list:e,version:i}=t;this.setRedirectVersion(i),this.userRedirect(e)}}setRedirectVersion(t){this.redirectVersion=t}userRedirect(t){t.forEach(t=>{let{matchs:e,version:i,target:s}=t;e=e.map(t=>new RegExp(t)),this.sites.forEach(t=>{t.forEach(t=>{var o;(null===(o=t.children)||void 0===o?void 0:o.length)?t.children.forEach(t=>{t.target&&e.some(e=>e.test(t.target))&&t.rVersion!==i&&(t.rVersion=i,t.target=s)}):t.target&&e.some(e=>e.test(t.target))&&t.rVersion!==i&&(t.rVersion=i,t.target=s)})})})}}f([n.g],w.prototype,"sites",void 0),f([n.g],w.prototype,"editingId",void 0),f([n.g],w.prototype,"currentPageIndex",void 0),f([n.g],w.prototype,"redirectVersion",void 0),f([n.e],w.prototype,"uids",null),f([n.b],w.prototype,"changeCurrentPage",null),f([n.b],w.prototype,"mergeRemote",null),f([n.b],w.prototype,"clearEditSite",null),f([n.b],w.prototype,"setEditSite",null),f([n.b],w.prototype,"delSites",null),f([n.b],w.prototype,"insertSite",null),f([n.b],w.prototype,"destroyFolder",null),f([n.b],w.prototype,"manualDestroyFolder",null),f([n.b],w.prototype,"finishingSites",null),f([n.b],w.prototype,"reSort",null),f([n.b],w.prototype,"addSite",null),f([n.b],w.prototype,"changeFolderName",null),f([n.b],w.prototype,"setWeatherIcon",null),f([n.b],w.prototype,"submitSite",null),f([n.b],w.prototype,"setRedirectVersion",null),f([n.b],w.prototype,"userRedirect",null);const v=new w;v.initSyncStore("store-site",["sites","redirectVersion"]),v.initAutoBackup("site",["sites"]),Object(n.h)(()=>[p.b.setting.layout.col,p.b.setting.layout.row].join(","),()=>{if(v.firstSync){const{col:t,row:e}=p.b.setting.layout;v.reSort(t,e),setTimeout(()=>{Object(p.a)(!1)},0)}});const I=()=>{requestIdleCallback(()=>{v.firstSync?v.sites.forEach((t,e)=>{t.forEach((t,i)=>{t||Object(n.i)(()=>{v.sites[e].splice(i,1)})})}):I()})};setTimeout(()=>{I()},60),Object(n.c)(()=>{if(m.weatherStore.firstSync){const t=Object(m.getCurrentWeather)();v.setWeatherIcon(v.sites,t)}},{delay:20}),Object(n.c)(()=>{v.firstSync&&requestIdleCallback(()=>{v.getRedirectTargets()})},{delay:20})},586:function(t,e,i){"use strict";i.d(e,"a",(function(){return b}));var s=i(582),o=i.n(s),r=i(105),a=i.n(r),n=(i(13),i(17),i(52),i(10),i(3)),l=i(246),c=i(194),d=i(14),p=i(81),u=i(0),h=i(390),y=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a};const g=u.C.isZh?c.a:c.b;class m extends l.a{constructor(){super(...arguments),this.list=[],this.defaultSearch=c.e,this.listHash="",this.version="",this.lang="",this.ignoreSuggest=!1,this.searchEngine={custom:[],addList:[],current:g,all:[Object.assign(Object.assign({},g),{updatetime:0}),Object.assign(Object.assign({},c.c),{updatetime:0})]},this.convertBackupEquals=t=>{var e,i;let s=null===(e=null==t?void 0:t.searchEngine)||void 0===e?void 0:e.all,o=null===(i=null==t?void 0:t.searchEngine)||void 0===i?void 0:i.current;if(s&&(s=t.searchEngine.all.map(t=>t.uuid)),o&&(o=t.searchEngine.current.uuid),s||o){const e=Object.assign(Object.assign({},t.searchEngine),{all:s,current:o});return Object.assign(Object.assign({},t),{searchEngine:e})}return t},this.mergeAddArray=(t=[],e=[])=>{const i="uuid";if(!t||0===t.length)return{result:e||[],isLocalEffective:!1};const s=e.filter(t=>!!t),r=t=>{if("object"==typeof t){var e;const i=o()(e=Object.keys(t).filter(t=>"uuid"!==t&&"updatetime"!==t)).call(e);return a()(i).call(i,(e,i)=>e+t[i],"")}},n=(t=>{const e=Object.create(null);return t.forEach(t=>{const i=r(t);e[i]=!0}),e})(e),l=Object.create(null);e.forEach((t,e)=>{if(t[i]){const s=t[i];l[s]=e}});let c=!1;return t.filter(t=>0!==t.updatetime).forEach(t=>{const e=r(t);if(n[e])return;const o=t[i],a=l[o];if(void 0!==a){(s[a].updatetime||0)<(t.updatetime||0)&&(s[a]=t,c=!0)}else c=!0,s.push(t)}),{result:s.filter(t=>!!t),isLocalEffective:c}}}get allItems(){return[this.defaultSearch,...this.searchEngine.all]}diffRemote(t){var e,i;const s=t.searchEngine||{};if(JSON.stringify(s.addList||{})!==JSON.stringify(this.searchEngine.addList))return!0;if(JSON.stringify(s.custom||{})!==JSON.stringify(this.searchEngine.custom))return!0;if((null===(e=s.current)||void 0===e?void 0:e.uuid)!==this.searchEngine.current.uuid)return!0;if((null===(i=s.all)||void 0===i?void 0:i.length)!==this.searchEngine.all.length)return!0;return this.searchEngine.all.some((t,e)=>{var i,o;return(null===(o=null===(i=s.all)||void 0===i?void 0:i[e])||void 0===o?void 0:o.uuid)!==t.uuid})}mergeRemote(t,e){if(t.searchEngine)if(e)this.searchEngine=this.transformSearchI18n(t.searchEngine);else{const e=this.searchEngine.custom,i=t.searchEngine.custom,{result:s}=d.a.mergeArray(e,i,"uuid"),o=this.searchEngine.addList,r=t.searchEngine.addList,{result:a}=this.mergeAddArray(o,r),n=this.searchEngine.all,l=t.searchEngine.all,{result:c}=d.a.mergeArray(n,l,"uuid");this.searchEngine=this.transformSearchI18n({custom:s,addList:a,current:t.searchEngine.current,all:c})}}transformSearchI18n(t){const e=Object.create(null);this.list.forEach(t=>{e[t.uuid]=t});const i=t=>e[t.uuid]?Object.assign(Object.assign({},t),e[t.uuid]):t;return{custom:t.custom,addList:t.addList,current:i(t.current),all:t.all.map(t=>i(t))}}setActive(t){this.searchEngine.current=this.allItems[t]}closeSuggestTips(){this.ignoreSuggest=!0}delShortcut(t){const e=this.searchEngine.all.findIndex(e=>e.uuid===t);e>-1&&this.searchEngine.all.splice(e,1)}updateShortcut(t){if(t){this.searchEngine.all.some((e,i)=>e.uuid===t.uuid&&(this.searchEngine.all[i]=t,!0))||this.searchEngine.all.push(t);const e=this.searchEngine.current.uuid;t.uuid===e&&(this.searchEngine.current=t)}}createEngine(t,e=null){if(null===e){const e=d.a.randomId("custom-search-"),i=Object.assign(Object.assign({},t),{uuid:e});return this.searchEngine.custom.push(i),i}return this.searchEngine.custom[e]=Object.assign(Object.assign({},this.searchEngine.custom[e]),t),this.searchEngine.custom[e]}delEngine(t){const{uuid:e}=this.searchEngine.custom[t];return e!==this.searchEngine.current.uuid&&(this.delShortcut(e),this.searchEngine.custom.splice(t,1),!0)}createEngineAdd(t,e=null){if(null===e){const e=d.a.randomId("add-search-"),i=Object.assign(Object.assign({},t),{uuid:e});return this.searchEngine.addList.push(Object.assign(Object.assign({},t),{uuid:e})),i}return this.searchEngine.addList[e]=Object.assign(Object.assign({},this.searchEngine.addList[e]),t),this.searchEngine.addList[e]}delEngineAdd(t){return this.searchEngine.addList.splice(t,1),!0}async getEnginesList(){let t=this.version;this.lang!==u.C.lang&&(t="");const{data:e,error:i}=await p.d.getEnginesList(t);if(!i&&(Object(n.i)(()=>{var t;this.version=null===(t=e.meta)||void 0===t?void 0:t.version,this.lang=u.C.lang}),e.hash!==this.listHash))if(h.userStore.isLogin)this.updateEngines({list:e.list,listHash:e.hash});else{this.stopAutoBackupReaction();try{this.updateEngines({list:e.list,listHash:e.hash})}catch(i){}this.restartAutoBackupReaction()}}updateEngines({list:t,listHash:e}){this.list=t,this.listHash=e;const i={};t.forEach(t=>{i[t.uuid]=t});const s=this.searchEngine.current.uuid;i[s]&&(this.searchEngine.current=i[s]);const o=this.defaultSearch.uuid;i[o]&&(this.defaultSearch=i[o]);const r=[];this.searchEngine.all.forEach(t=>{const e=t.uuid;i[e]?0===t.updatetime?r.push(Object.assign(Object.assign({},i[e]),{updatetime:0})):r.push(Object.assign({},i[e])):r.push(t)}),this.searchEngine.all=r}sortShortcut(t,e){if(t===e)return;const i=[...this.searchEngine.all],s=i.findIndex(e=>e.uuid===t);if(-1!==s){if("all"===e){const[t]=i.splice(s,1);i.push(t)}else{const t=i.findIndex(t=>t.uuid===e);if(-1===t)return;const[o]=i.splice(s,1);i.splice(t,0,o)}this.searchEngine.all=i}}}y([n.g],m.prototype,"list",void 0),y([n.g],m.prototype,"defaultSearch",void 0),y([n.g],m.prototype,"listHash",void 0),y([n.g],m.prototype,"version",void 0),y([n.g],m.prototype,"lang",void 0),y([n.g],m.prototype,"ignoreSuggest",void 0),y([n.g],m.prototype,"searchEngine",void 0),y([n.e],m.prototype,"allItems",null),y([n.b],m.prototype,"mergeRemote",null),y([n.b],m.prototype,"setActive",null),y([n.b],m.prototype,"closeSuggestTips",null),y([n.b],m.prototype,"delShortcut",null),y([n.b],m.prototype,"updateShortcut",null),y([n.b],m.prototype,"createEngine",null),y([n.b],m.prototype,"delEngine",null),y([n.b],m.prototype,"createEngineAdd",null),y([n.b],m.prototype,"delEngineAdd",null),y([n.b],m.prototype,"getEnginesList",null),y([n.b],m.prototype,"updateEngines",null),y([n.b],m.prototype,"sortShortcut",null);const b=new m;b.initSyncStore("store-search",["searchEngine","list","listHash","ignoreSuggest","version","lang"],{list:c.g}),b.initAutoBackup("searcher",["searchEngine"]),requestIdleCallback(()=>{b.getEnginesList()})},587:function(t,e,i){"use strict";i.d(e,"a",(function(){return y}));var s=i(582),o=i.n(s),r=(i(13),i(17),i(10),i(3)),a=i(368),n=i.n(a),l=i(246),c=i(81),d=i(14),p=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a};const u=[{title:"",content:"",time:+new Date,id:"note-default-1ehj4oc7ubn8bgu9zb2spjip0vj",updatetime:0,fontSize:14}];class h extends l.a{constructor(){super(...arguments),this.linkModal=!1,this.list=u,this.checkedId=this.list[0].id,this.boldActive=!1}toogleLinkModal(){this.linkModal=!this.linkModal}setBoldActive(t){this.boldActive=t}get isEmpty(){return 0===this.list.length}get checkedNote(){return this.checkedId?this.list.filter(t=>t.id===this.checkedId)[0]:this.list[0]}get sortList(){var t,e;return(null===(t=this.list)||void 0===t?void 0:t.length)?o()(e=this.list.slice()).call(e,(t,e)=>e.time-t.time):[]}diffRemote(t){const e=t=>{if(null==t?void 0:t.updatetime){const e={updatetime:void 0};return Object.assign(Object.assign({},t),e)}},i=n()(t.list||[],e),s=n()(Object(r.j)(this.list),e);return!r.d.structural(i,s)}mergeRemote(t,e){if(t.list)if(e)this.list=t.list,this.checkedId=t.checkedId;else{const e=this.list,i=t.list;this.checkedId=t.checkedId;const{result:s}=d.a.mergeArray(e,i);this.list=s}}async add({title:t="",content:e=""}){const i=d.a.randomId("note-"),s=await d.a.getTimestamp(),o={title:t,content:e,time:+new Date,id:i,updatetime:s,fontSize:14};Object(r.i)(()=>{this.list=[o,...this.list],this.checkedId=i})}delete(t){this.list=this.list.filter(e=>e.id!==t),t!==this.checkedId||this.isEmpty||(this.checkedId=this.list[0].id)}updateId(t){this.checkedId=t}async updateNote(t){const e=await d.a.getTimestamp();Object(r.i)(()=>{var i;(null===(i=this.list)||void 0===i?void 0:i.length)&&(this.list=this.list.map(i=>i.id===t.id?Object.assign(Object.assign(Object.assign({},i),t),{updatetime:e}):Object.assign({},i)))})}async upload(t,e){var i,s;const{data:o,error:r}=await c.f.uploadFile(t,e+".png","infinity-notes-img");if(r){return{error:(null===(s=null===(i=r.response)||void 0===i?void 0:i.data)||void 0===s?void 0:s.error)?r.response.data.error:r.message,data:""}}return{data:o,error:""}}}p([r.g],h.prototype,"linkModal",void 0),p([r.b],h.prototype,"toogleLinkModal",null),p([r.g],h.prototype,"list",void 0),p([r.g],h.prototype,"checkedId",void 0),p([r.g],h.prototype,"boldActive",void 0),p([r.b],h.prototype,"setBoldActive",null),p([r.e],h.prototype,"isEmpty",null),p([r.e],h.prototype,"checkedNote",null),p([r.e],h.prototype,"sortList",null),p([r.b],h.prototype,"mergeRemote",null),p([r.b],h.prototype,"add",null),p([r.b],h.prototype,"delete",null),p([r.b],h.prototype,"updateId",null),p([r.b],h.prototype,"updateNote",null),p([r.b],h.prototype,"upload",null);const y=new h;y.initSyncStore("store-notes",["list","checkedId"],{},!0),y.initAutoBackup("note",["list","checkedId"])},589:function(t,e,i){"use strict";var s=i(48),o=i.n(s),r=(i(13),i(17),i(10),i(52),i(3)),a=i(81),n=i(358),l=i(605),c=i(26),d=i.n(c),p=i(14),u=i(346),h=i(588),y=i(190),g=i(131),m=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a};const b=i(614)();class f{constructor(){this.cloudItems=[],this.setCloudItems=t=>this.cloudItems=t,this.appendCloudItems=t=>this.cloudItems.push(...t),this.recentItems=[],this.localItems=[],this.setLocalItems=t=>this.localItems=t,this.appendLocalItem=t=>{if(-1===this.localItems.findIndex(({id:e})=>e===t.id)){const e=Object(r.j)(this.localItems);this.setLocalItems([t].concat(e))}},this.collectItems=[],this.inLoading=!1,this.setInLoading=t=>this.inLoading=t,this.empty=!1,this.setEmpty=t=>this.empty=t,this.inLoadingNext=!1,this.setInLoadingNext=t=>this.inLoadingNext=t,this.error=!1,this.setError=t=>this.error=t,this.commonColorItems=[],this.filterCondition={},this._pageCount=0,this.mapToIcon={},this.removeFilterTag=()=>this.filterCondition.tag&&(this.filterCondition.tag=null),this.removeFilterColor=()=>this.filterCondition.color&&(this.filterCondition.color=null),this.localPObjectStore=d.a.createInstance({name:"idb-wallpaper",storeName:"store-local-wallpaper"}),this._loadLocalWallpapers()}setRecentItems(t){this.recentItems=t}async removeLocalItem(t){const e=this.localItems.findIndex(({id:e})=>e===t);-1!==e&&this.localItems.splice(e,1),await this.localPObjectStore.removeItem(t)}setCollectItems(t){this.collectItems=t}removeCollectItem(t){const e=this.collectItems.findIndex(({id:e})=>e===t);-1!==e&&this.collectItems.splice(e,1)}showItemExtraOpts(t){this.itemExtraOptsState===t?this.itemExtraOptsState=void 0:this.itemExtraOptsState=t}hideItemExtraOpts(){this.itemExtraOptsState=void 0}likeWp(t,e){const i=this.cloudItems.find(({id:e})=>e===t);i&&(1===e?i.like++:i.like>0&&i.like--)}initDataIfNeeded(){this.commonColorItems=[{id:window.__INFINITY__.wpColorId+"_1",type:"color",content:"#E1E1E1"},{id:window.__INFINITY__.wpColorId+"_2",type:"color",content:"#EE6D52"},{id:window.__INFINITY__.wpColorId+"_3",type:"color",content:"#FBAF42"},{id:window.__INFINITY__.wpColorId+"_4",type:"color",content:"#FFE000"},{id:window.__INFINITY__.wpColorId+"_5",type:"color",content:"#84D071"},{id:window.__INFINITY__.wpColorId+"_6",type:"color",content:"#6BC7DB"},{id:window.__INFINITY__.wpColorId+"_7",type:"color",content:"#4F9FED"},{id:window.__INFINITY__.wpColorId+"_8",type:"color",content:"#8D68E0"}],window.__INFINITY__.wallpaper_sources.forEach(t=>{this.mapToIcon[t.value]=t.icon})}async _loadLocalWallpapers(){const t=[];await this.localPObjectStore.iterate(e=>{const i=o.a.createObjectURL(e.file);if(e.rawUrl=e.url=i,e.smallFile){const t=o.a.createObjectURL(e.smallFile);e.content=t}else e.content=i;t.push(e)}),this.setLocalItems(t)}isFilterTag(t){return this.filterCondition.tag===t}setFilterTag(t){this.filterCondition.tag=t}isFilterColor(t){return this.filterCondition.color===t}setFilterColor(t){this.filterCondition.color=t}isFilterOrder(t){return this.filterCondition.order===t}setFilterOrder(t){this.filterCondition.order=t}clearState(){this.error&&this.setError(!1),this.empty&&this.setEmpty(!1),this.inLoading&&this.setInLoading(!1),this.inLoadingNext&&this.setInLoadingNext(!1)}async loadNextPage(){if(!(this.filterCondition.page>this._pageCount)){this.clearState(),this.setInLoadingNext(!0);try{const t=await this.loadWallpapersRaw(this.filterCondition);this.filterCondition.page=t.nextPage,this._pageCount=t.totalPages,this.appendCloudItems(t.data)}finally{this.setInLoadingNext(!1)}}}async loadCloudWallpapers(){const t=await this.loadWallpapersRaw(Object.assign(this.filterCondition,{page:0}));return this.filterCondition.page=t.nextPage,this._pageCount=t.totalPages,t.data}async loadWallpapersRaw(t){const{result:e,error:i}=await a.h.getWallpapers(t);if(i)throw i.__CANCEL__||(this.setError(!0),n.default.error(i.message),this.setInLoading(!1)),i;if(e.success)return e.data=Object(u.a)(e.data),e;throw n.default.error(i18n("unknown_mistake")),this.setError(!0),new Error(e)}async loadLocalImage(t){if(t.size>window.__INFINITY__.xMaxLocalFileSize)return void n.default.error(i18n("wallpaper_upload_file_size_exceed"));let e,i=t;try{Object(u.e)(t)&&(e=n.default.loading(i18n("wallpaper_loading")),await p.a.sleep(150),i=await Object(l.a)(t,{maxSizeMB:window.__INFINITY__.maxLocalFileSize/1024/1024,maxWidthOrHeight:window.__INFINITY__.minFileMaxWidthOrHeight,useWebWorker:!1}));const s=await this.addFileToLocal(i);return this.appendLocalItem(s),s}catch(t){n.default.error(i18n("wallpaper_apply_from_local_error"))}finally{e&&e()}}async resizeImage(t){const e=await Object(g.b)(t),i=document.createElement("canvas");i.width=y.imgConfig.smallWidth*window.devicePixelRatio,i.height=y.imgConfig.smallWidth/e.naturalWidth*e.naturalHeight*window.devicePixelRatio;const s=await b.resize(e,i);return await b.toBlob(s)}async addFileToLocal(t){const e={type:"local",id:`${window.__INFINITY__.wpId}${Object(h.a)()}`,file:t};e.similarColor=await p.a.getSimilarColor(t);const i=o.a.createObjectURL(t),s=await this.resizeImage(i);e.smallFile=s,await this.localPObjectStore.setItem(e.id,e);const r=o.a.createObjectURL(s);return e.rawUrl=e.url=i,e.content=r,e}}m([r.g],f.prototype,"cloudItems",void 0),m([r.b],f.prototype,"setCloudItems",void 0),m([r.b],f.prototype,"appendCloudItems",void 0),m([r.g],f.prototype,"recentItems",void 0),m([r.b],f.prototype,"setRecentItems",null),m([r.g],f.prototype,"localItems",void 0),m([r.b],f.prototype,"setLocalItems",void 0),m([r.b],f.prototype,"removeLocalItem",null),m([r.g],f.prototype,"collectItems",void 0),m([r.b],f.prototype,"setCollectItems",null),m([r.b],f.prototype,"removeCollectItem",null),m([r.g],f.prototype,"itemExtraOptsState",void 0),m([r.b],f.prototype,"showItemExtraOpts",null),m([r.b],f.prototype,"hideItemExtraOpts",null),m([r.g],f.prototype,"inLoading",void 0),m([r.b],f.prototype,"setInLoading",void 0),m([r.g],f.prototype,"empty",void 0),m([r.b],f.prototype,"setEmpty",void 0),m([r.g],f.prototype,"inLoadingNext",void 0),m([r.b],f.prototype,"setInLoadingNext",void 0),m([r.g],f.prototype,"error",void 0),m([r.b],f.prototype,"setError",void 0),m([r.b],f.prototype,"likeWp",null),m([r.g],f.prototype,"commonColorItems",void 0),m([r.b],f.prototype,"initDataIfNeeded",null),m([r.g],f.prototype,"filterCondition",void 0),m([r.b],f.prototype,"setFilterTag",null),m([r.b],f.prototype,"setFilterColor",null),m([r.b],f.prototype,"setFilterOrder",null),m([r.b],f.prototype,"removeFilterTag",void 0),m([r.b],f.prototype,"removeFilterColor",void 0),m([r.b],f.prototype,"clearState",null);const w=new f;e.a=w},593:function(t,e,i){"use strict";var s=i(7),o=i.n(s),r=(i(10),i(13),i(17),i(14)),a=i(3),n=i(358),l=i(257),c=i(605),d=i(606),p=i.n(d),u=i(190),h=i(588),y=i(346),g=i(0),m=function(t,e,i,s){var o,r=arguments.length,a=r<3?e:null===s?s=Object.getOwnPropertyDescriptor(e,i):s;if("object"==typeof Reflect&&"function"==typeof Reflect.decorate)a=Reflect.decorate(t,e,i,s);else for(var n=t.length-1;n>=0;n--)(o=t[n])&&(a=(r<3?o(a):r>3?o(e,i,a):o(e,i))||a);return r>3&&a&&Object.defineProperty(e,i,a),a};class b{constructor(){this.setSwitchType=t=>this.switchTypeInUI=t,this.setPSource=t=>this.pSource=t,this.customLibraryMap={},this.customLibrary=[],this.setCustomLibrary=t=>this.customLibrary=t,this.maxCountPerLibrary=20,this.maxFileLenPerUpload=20,this._maxPerQueue=4,this._uploadKey="custom-wallpaper-library",this.switch_interval_options={"when-newtab":g.r?i18n("wallpaper_switch_when_open_web"):i18n("wallpaper_switch_when_open"),"per-hour":i18n("wallpaper_switch_per_hour"),"twelve-hour":i18n("wallpaper_switch_per_twelve_hour"),"one-day":i18n("wallpaper_switch_everyday")},this.iOptionsModalShow=!1,this.toggleIOptionsModal=t=>{t.stopPropagation(),this.iOptionsModalShow?this.iOptionsModalShow=!1:this.iOptionsModalShow=!0},this.mapUploadWallpapers=t=>t.map(t=>{const{content:e,url:i,rawUrl:s}=Object(u.convertURL)(t.url);return t.type="user-library",t.content=e,t.url=i,t.rawUrl=s,t})}setCustomLibraryMap(t,e){this.customLibraryMap[t]=e}delCustomLibraryMap(t){delete this.customLibraryMap[t]}clearCustomLibraryMap(){this.customLibraryMap={}}popCustomLibraryItem(t,e){const i=this.customLibraryMap[t],s=i.findIndex(({id:t})=>t===e);-1!==s&&i.splice(s,1)}appendCustomLibraryItem(t,e){const i=this.customLibraryMap[t];this.customLibraryMap[t]=i.concat(e)}getLibraryItems(t){return this.customLibraryMap[t]}getLibraryCoverImg(t){const e=this.customLibraryMap[t];return e&&e.length>0?e[0].content:null}popCustomLibrary(t){const e=this.customLibrary.findIndex(({libraryId:e})=>e===t);-1!==e&&this.customLibrary.splice(e,1)}appendCustomLibrary(t){this.customLibrary.push(t)}setCustomLibraryName(t,e){const i=this.customLibrary.findIndex(({libraryId:e})=>e===t);-1!==i&&(this.customLibrary[i].libraryName=e)}closeIOptionsModal(){this.iOptionsModalShow&&(this.iOptionsModalShow=!1)}async renameLibraryName(t,e){this.setCustomLibraryName(t,e),await Object(u.renameWallpaperLibrary)(t,e)}async removeWallpaperLibrary(t){const e=n.default.loading(i18n("wallpaper_loading"));try{await Object(u.removeWallpaperLibrary)(t),this.delCustomLibraryMap(t),this.popCustomLibrary(t)}finally{e()}}async loadUserWallpaperLibrary(){const t=(await Object(u.getUserWallpaperLibrary)()).data;this.setCustomLibrary(t),t.length>0&&await o.a.all(t.map(({libraryId:t})=>(async()=>{const e=await Object(u.getWallpaperLibraryItems)(t);this.setCustomLibraryMap(t,e.items)})()))}_filesPreCheck(t){return t.filter(t=>!(t.size>window.__INFINITY__.xMaxLocalFileSize))}async addImagesToLibrary(t,e){const i=this._filesPreCheck(e);if(0===i.length)return void n.default.error(i18n("wallpaper_upload_file_size_exceed"));i.length!==e.length&&n.default.error(i18n("wallpaper_upload_file_size_exceed"));const s=await this._uploadFileToCloudRaw(t,i);return await Object(u.addImagesToLibrary)(t,s),this.mapUploadWallpapers(s)}async createWallpaperLibrary(t){const e=this._filesPreCheck(t);if(0===e.length)return;const i=n.default.loading(i18n("wallpaper_loading"));try{const t=r.a.randomId(`${window.__INFINITY__.wpLibraryId}${Object(h.a)()}`),s=i18n("add_new_wallpaper_libary"),o=await this._uploadFileToCloudRaw(t,e),a=await Object(u.createWallpaperLibrary)({libraryName:s,libraryId:t,wallpapers:o});if(6001===a.code)return void n.default.error(a.message);const l=this.mapUploadWallpapers(o);this.appendCustomLibrary({libraryId:t,libraryName:s}),this.setCustomLibraryMap(t,l)}catch(t){throw n.default.error(i18n("wallpaper_create_library_error")),t}finally{i()}}async createWallpaperLibraryOnly(t,e){try{const i=await Object(u.createWallpaperLibrary)({libraryName:e,libraryId:t});if(6001===i.code)return void n.default.error(i.message);this.appendCustomLibrary({libraryId:t,libraryName:e}),this.setCustomLibraryMap(t,[])}catch(t){throw n.default.error(i18n("wallpaper_create_library_error")),t}}async _uploadFileToCloudRaw(t,e){const i=await this._handleLocalFiles(e),s=await this._uploadFileToCloud(i,t);return Array.apply(null,{length:s.length}).map((e,o)=>{const{id:r,similarColor:a}=i[o],{key:n,url:l}=s[o].data;return{id:r,key:n,url:l,libraryId:t,similarColor:a}})}_uploadFileToCloud(t,e){return o.a.all(t.map(({file:t,id:i})=>new o.a((s,o)=>{Object(l.uploadFile)(t,`${e}/${i}.${p.a.getExtension(t.type)}`,this._uploadKey).then(t=>{t.error?o(t):s(t)})})))}async _handleLocalFiles(t){const e=async t=>{let e=t;return Object(y.e)(t)&&(e=await Object(c.a)(t,{maxSizeMB:window.__INFINITY__.maxLocalFileSize/1024/1024,maxWidthOrHeight:window.__INFINITY__.minFileMaxWidthOrHeight,useWebWorker:!1})),{file:e,similarColor:await r.a.getSimilarColor(e)}},i=[];for(let s=0,r=t.length;s<r;s++)i.push(await e(t[s])),await new o.a(t=>setTimeout(t,100));return(t=>t.map(({file:t,similarColor:e})=>({id:r.a.randomId(`${window.__INFINITY__.wpLibraryItemId}${Object(h.a)()}`),file:t,similarColor:e})))(i)}}m([a.g],b.prototype,"switchTypeInUI",void 0),m([a.b],b.prototype,"setSwitchType",void 0),m([a.g],b.prototype,"pSource",void 0),m([a.b],b.prototype,"setPSource",void 0),m([a.g],b.prototype,"customLibraryMap",void 0),m([a.b],b.prototype,"setCustomLibraryMap",null),m([a.b],b.prototype,"delCustomLibraryMap",null),m([a.b],b.prototype,"clearCustomLibraryMap",null),m([a.b],b.prototype,"popCustomLibraryItem",null),m([a.b],b.prototype,"appendCustomLibraryItem",null),m([a.g],b.prototype,"customLibrary",void 0),m([a.b],b.prototype,"setCustomLibrary",void 0),m([a.b],b.prototype,"popCustomLibrary",null),m([a.b],b.prototype,"appendCustomLibrary",null),m([a.b],b.prototype,"setCustomLibraryName",null),m([a.g],b.prototype,"iOptionsModalShow",void 0),m([a.b],b.prototype,"closeIOptionsModal",null),m([a.b],b.prototype,"toggleIOptionsModal",void 0),m([a.b],b.prototype,"removeWallpaperLibrary",null);const f=new b;e.a=f}}]);